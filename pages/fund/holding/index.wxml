<view class="mode" style="margin-top: {{tabbarRealHeight  + 'px'}}; height: calc(100vh - {{tabbarRealHeight +90 + 'px'}});">
  <view class="holdingInfo">
    <view class="holdingInfo-title">
      <view>持仓总览</view>
      <view bindtap="toProfitLossUserRecord">数据统计</view>
    </view>
    <view class="holdingInfo-content">
      <view class="content-top">
        <view class="content-top-left {{userTotalInfo.total_profit_user_today >= 0 ? 'profit' : 'loss'}}">¥{{userTotalInfo.total_profit_user_today}}</view>
        <view class="content-top-right" bindtap="updateTotalAssetsUser">
          <view>总投入</view>
          <view>{{userTotalInfo.total_assets_user}}</view>
        </view>
      </view>
      
      <view class="content-bottom">
        <view>
          <view>总资产</view>
          <view>{{userTotalInfo.total_available_assets_user}}</view>
        </view>
        <view>
          <view>总盈亏</view>
          <view>{{userTotalInfo.total_profit_user}}</view>
        </view>
        <view>
          <view>总市值</view>
          <view>{{userTotalInfo.total_market_value_user}}</view>
        </view>
        <view>
          <view>可用</view>
          <view>{{userTotalInfo.available_user}}</view>
        </view>
      </view>
      <view class="content-process">
        <view class="process-bar">
          <view class="process-bar-inner" style="width: {{userTotalInfo.holding_position_user}}%"></view>
        </view>
        <view class="process-text">
          <text>仓位</text>
          <text>{{userTotalInfo.holding_position_user}}%</text>
        </view>
      </view>
    </view>
  </view>

  <view class="holding-list">
    <view class="list-header">
      <view>基金名称</view>
      <view class="list-batch">
        <view bindtap="toBatchBuySell">
          <image src="/static/image/buysell.png" mode="widthFix"></image>
          <view>批量买卖</view>
        </view>
        <view bindtap="batchUpdateProfit">
          <image src="/static/image/profitloss.png" mode="widthFix"></image>
          <view>自动盈亏</view>
        </view>
      </view>
    </view>
    <view class="list-sort">
      <view wx:for="{{sortType}}" wx:key="id" bindtap="handleSortTypeChange" data-type="{{item.type}}" data-sort="{{item.sort}}">
        <view>{{item.name}}</view>
        <view>
          <image src="/static/image/uptriangleactive.png" mode="widthFix" wx:if="{{item.sort === 'up'}}"></image>
          <image src="/static/image/uptriangle.png" mode="widthFix" wx:else></image>
          <image src="/static/image/downtriangleactive.png" mode="widthFix" wx:if="{{item.sort === 'down'}}"></image>
          <image src="/static/image/downtriangle.png" mode="widthFix" wx:else></image>
        </view>
      </view>
    </view>
      
    <view class="list-content">
      <view class="list-item" wx:for="{{holdingList}}" wx:key="id" >
        <!-- 完整显示 -->
        <view class="item-complete" wx:if="{{expandedFundId === item.id}}">
          <view class="item-top" bindtap="toggleFundExpand" data-id="{{item.id}}">
            <view class="item-left">
              <view class="fund-name">{{item.fund_name}}</view>
              <view class="fund-code">{{item.code}}</view>
            </view>
            <view class="item-right">
              <view class="profit-amount {{item.dailyData.profit_loss > 0 ? 'profit' : 'loss'}}">{{item.dailyData.profit_loss ? item.dailyData.profit_loss : '--'}}</view>
            </view>
          </view>
          <view class="bottom-detail">
            <view class="bottom-detail-line">
              <view>
                <view>持有市值 / 总成本</view>
                <view>{{item.holding_amount}}<text>元</text> / {{item.total_cost}}<text>元</text></view>
              </view>
              <view>
                <view>成本 / 现价</view>
                <view>{{item.holding_cost}}<text>元</text> / {{item.current_net_value}}<text>元</text></view>
              </view>
            </view>
            <view class="bottom-detail-line">
              <view>
                <view> 份额 / 仓位</view>
                <view>{{item.holding_shares}}<text>股</text> / {{item.holding_position}}<text>%</text></view>
              </view>
              <view>
                <view>持有盈亏 / 盈亏率</view>
                <view>{{item.holding_profit}}<text>元</text> / {{item.holding_profit_rate_percentage}}<text>%</text></view>
              </view>
            </view>
            <view class="bottom-detail-process">
              <view class="bottom-detail-process-left">
                <view class="process-block">
                  <view class="process-block-inner" style="width: {{item.holding_position}}%"></view>
                </view>
                <view class="process-text" style="margin-top: 5rpx;">
                  <text>个股仓位</text>
                  <text>{{item.holding_position}}%</text>
                </view>
              </view>
              <view class="bottom-detail-process-right">
                <view>卖出盈亏</view>
                <view>{{item.sell_profit}}</view>
              </view>
              <view class="bottom-detail-process-right">
                <view>累计盈亏</view>
                <view>{{item.total_profit}}</view>
              </view>
            </view>
            <view class="item-mode">
              <view bindtap="toBuySellRecord" data-item="{{item}}">
                <view>买卖记录</view>
                <image src="/static/image/tools/24.png" mode="widthFix"></image>
              </view>
              <view bindtap="toProfitLossRecord" data-item="{{item}}">
                <view>盈亏记录</view>
                <image src="/static/image/tools/23.png" mode="widthFix"></image>
              </view>
              <view bindtap="toLLMAnalysis" data-item="{{item}}">
                <view>量化模型</view>
                <image src="/static/image/tools/22.png" mode="widthFix"></image>
              </view>
            </view>
          </view>
          <view class="bottom-detail-btn">
            <view bindtap="showBuySellDrawer" data-item="{{item}}">买入卖出</view>
            <view bindtap="showUpdateProfitDrawer" data-item="{{item}}">更新盈亏</view>
            <view bindtap="showFundDrawer" data-type="edit" data-item="{{item}}">编辑</view>
            <view bindtap="deleteFund" data-id="{{item.id}}">删除</view>
          </view>
        </view>
        <!-- 缩略显示 -->
        <view class="item-omit" wx:else bindtap="toggleFundExpand" data-id="{{item.id}}">
          <view class="omit-top">
            <view class="fund-name">{{item.fund_name}}</view>
            <view class="omit-right">
              <view class="omit-amount {{item.dailyData.profit_loss > 0 ? 'profit' : 'loss'}}">{{item.dailyData.profit_loss ? item.dailyData.profit_loss : '--'}}</view>
            </view>
          </view>
          <view class="omit-bottom">
            <view class="omit-bottom-line">
              <view>
                <view>市值 / 份额</view>
                <view>{{item.holding_amount}} / {{item.holding_shares}}</view>
              </view>
              <view>
                <view>成本 / 现价</view>
                <view>{{item.holding_cost}} / {{item.current_net_value}}</view>
              </view>
              <view>
                <view>盈亏 / 盈亏率</view>
                <view>{{item.holding_profit}} / {{item.holding_profit_rate_percentage}}</view>
              </view>
            </view>
          </view>
            
        </view>
      </view>
      <view class="add-btn" bindtap="showFundDrawer" data-type="add">新增基金</view>
    </view>
  </view>
</view>


<!-- 欢迎弹窗 -->
<view class="drawer-mask" wx:if="{{showWelcomeDrawer}}" bindtap="closeWelcomeDrawer"></view>
<view class="drawer {{showWelcomeDrawer ? 'drawer-show' : ''}}">
  <view class="drawer-header">
    <view class="drawer-title">{{ welcomeStep === 1 ? '欢迎使用' : '开始第一步' }}</view>
    <view class="drawer-close" bindtap="closeWelcomeDrawer">×</view>
  </view>
  <view class="drawer-content" wx:if="{{welcomeStep === 1}}">
    <view class="operation-steps">
      <view class="operation-steps-title">你将启用投资量化助手，开始你的理财之旅吧！</view>
      <view class="step">
        <view class="step-title">第一步</view>
        <view class="step-content">
          <view class="step-content-title">设定本金</view>
          <view class="step-content-desc">先设定一笔用于投资的本金。</view>
        </view>
      </view>
      <view class="step">
        <view class="step-title">第二步</view>
        <view class="step-content">
          <view class="step-content-title">添加基金</view>
          <view class="step-content-desc">新增一支基金，作为你投资的开始。</view>
        </view>
      </view>
      <view class="step">
        <view class="step-title">第三步</view>
        <view class="step-content">
          <view class="step-content-title">买入卖出</view>
          <view class="step-content-desc">导入你的买卖记录，我们会记录它。</view>
        </view>
      </view>
      <view class="step">
        <view class="step-title">第四步</view>
        <view class="step-content">
          <view class="step-content-title">更新盈亏</view>
          <view class="step-content-desc">更新你的盈亏情况，交给系统帮你量化。</view>
        </view>
      </view>
    </view>
    <view class="btn-group">
      <view class="wx-login-btn" bindtap="welcomeToNextStep" data-step="1">我准备好了</view>
      <view style="height: 20rpx;"></view>
    </view>
  </view>
  <view class="drawer-content" wx:if="{{welcomeStep === 2}}">
    <view class="form-row">
      <view class="form-item">
        <view class="account-title">设定本金<text class="required">*</text></view>
        <view class="account-input">
          <input type="number" value="{{userTotalInfo.total_assets_user}}" data-field="total_assets_user" bindinput="setTotalAssetsUser" placeholder="请输入本金" />
        </view>
      </view>
    </view>
    <view class="btn-group">
      <view class="wx-login-btn" bindtap="welcomeToNextStep" data-step="2">就这样</view>
      <view style="height: 20rpx;"></view>
    </view>
  </view>
</view>

<!-- 新增/编辑基金弹窗 -->
<view class="drawer-mask" wx:if="{{showAddUpdateFundDrawer}}" bindtap="closeFundDrawer"></view>
<view class="drawer {{showAddUpdateFundDrawer ? 'drawer-show' : ''}}">
  <view class="drawer-header">
    <view class="drawer-title">{{addUpdateFundType === 'add' ? '新增基金' : '编辑基金'}}</view>
    <view class="drawer-close" bindtap="closeFundDrawer">×</view>
  </view>
  <view class="drawer-content">
    <view class="form-group">
      <view class="form-row">
        <view class="form-item">
          <view class="account-title">基金名称<text class="required">*</text></view>
          <view class="account-input">
            <input type="text" value="{{fundFormData.fund_name}}" data-field="fund_name" bindinput="handleInput" placeholder="请输入基金名称" />
          </view>
        </view>
      </view>

      <view class="form-row">
        <view class="form-item">
          <view class="account-title">基金代码<text class="required">*</text></view>
          <view class="account-input">
            <input type="number" value="{{fundFormData.code}}" data-field="code" bindinput="handleInput" placeholder="请输入基金代码" />
          </view>
        </view>
      </view>
      <view class="form-row">
        <view class="form-item">
          <view class="account-title">指数代码<text class="required">*</text></view>
          <view class="account-input">
            <input type="number" value="{{fundFormData.index_code}}" data-field="index_code" bindinput="handleInput" placeholder="请输入指数代码" />
          </view>
        </view>
      </view>
    </view>

    <view class="btn-group">
      <view class="wx-login-btn" bindtap="submitAddUpdateFund">提交</view>
      <view class="otherlogin" bindtap="closeFundDrawer">取消</view>
    </view>
  </view>
</view>

<!-- 买入卖出弹窗 -->
<view class="drawer-mask" wx:if="{{showBuySellDrawer}}" bindtap="closeBuySellDrawer"></view>
<view class="drawer {{showBuySellDrawer ? 'drawer-show' : ''}}">
  <view class="drawer-header">
    <view class="drawer-title">买入卖出</view>
    <view class="drawer-close" bindtap="closeBuySellDrawer">×</view>
  </view>
  <view class="drawer-content">
    <view class="form-group">
      <view class="form-row">
        <view class="form-item">
          <view class="account-title">基金名称</view>
          <view class="account-input">
            <input type="text" value="{{buySellFormData.fund_name}}" disabled placeholder="基金名称" />
          </view>
        </view>
      </view>

      <view class="form-row">
        <view class="form-item">
          <view class="account-title">交易类型<text class="required">*</text></view>
          <view class="profit-switch">
            <view class="switch-item" wx:for="{{transactionTypes}}" wx:key="id" bindtap="handleTransactionTypeChange" data-value="{{item.value}}">
              <view class="{{item.value === buySellFormData.transaction_type ? 'active' : ''}}">{{item.name}}</view>
            </view>
          </view>
        </view>
        <view class="form-item">
          <view class="account-title">交易日期<text class="required">*</text></view>
          <view class="account-input">
            <picker mode="date" value="{{buySellFormData.transaction_date}}" bindchange="handleTransactionDateChange">
              <view class="{{buySellFormData.transaction_date ? '' : 'placeholderClass'}}">
                {{buySellFormData.transaction_date || '请选择日期'}}
              </view>
            </picker>
          </view>
        </view>
      </view>

      <view class="form-row">
        <view class="form-item">
          <view class="account-title">现价<text class="required">*</text></view>
          <view class="account-input">
            <input type="digit" value="{{buySellFormData.net_value}}" data-field="net_value" bindinput="handleBuySellInput" placeholder="请输入现价" />
          </view>
        </view>
        <view class="form-item">
          <view class="account-title">份额<text class="required">*</text></view>
          <view class="account-input shares-input" style="padding-right: 0;">
            <image src="/static/image/reduce.png" mode="widthFix" bindtap="addReduceSharesHundred" data-type="reduce" />
            <input type="digit" value="{{buySellFormData.shares}}" data-field="shares" bindinput="handleBuySellInput" placeholder="份额" />
            <image src="/static/image/add.png" mode="widthFix" bindtap="addReduceSharesHundred" data-type="add" />
          </view>
        </view>
        <view class="form-item">
          <view class="account-title">金额</view>
          <view class="account-input">
            <input type="digit" value="{{buySellFormData.amount}}" disabled placeholder="自动计算金额" />
          </view>
        </view>
      </view>
    </view>

    <view class="btn-group">
      <view class="wx-login-btn" bindtap="submitBuySell">提交</view>
      <view class="otherlogin" bindtap="closeBuySellDrawer">取消</view>
    </view>
  </view>
</view>

<!-- 更新盈亏弹窗 -->
<view class="drawer-mask" wx:if="{{showUpdateProfitDrawer}}" bindtap="closeUpdateProfitDrawer"></view>
<view class="drawer {{showUpdateProfitDrawer ? 'drawer-show' : ''}}">
  <view class="drawer-header">
    <view class="drawer-title">更新盈亏</view>
    <view class="drawer-close" bindtap="closeUpdateProfitDrawer">×</view>
  </view>
  <view class="drawer-content">
    <view class="form-group">
      <view class="form-row">
        <view class="form-item">
          <view class="account-title">基金名称</view>
          <view class="account-input">
            <input type="text" value="{{updateProfitFormData.fund_name}}" disabled placeholder="基金名称" />
          </view>
        </view>
      </view>

      <view class="form-row">
        <view class="form-item">
          <view class="account-title">现价<text class="required">*</text></view>
          <view class="account-input">
            <input type="digit" value="{{updateProfitFormData.current_net_value}}" data-field="current_net_value" bindinput="handleUpdateProfitInput" placeholder="请输入现价" />
          </view>
        </view>
        <view class="form-item">
          <view class="account-title">交易日期<text class="required">*</text></view>
          <view class="account-input">
            <picker mode="date" value="{{updateProfitFormData.transaction_date}}" bindchange="handleUpdateProfitDateChange">
              <view class="{{updateProfitFormData.transaction_date ? '' : 'placeholderClass'}}">
                {{updateProfitFormData.transaction_date || '请选择日期'}}
              </view>
            </picker>
          </view>
        </view>
      </view>
    </view>

    <view class="btn-group">
      <view class="wx-login-btn" bindtap="submitUpdateProfit">提交</view>
      <view class="otherlogin" bindtap="deleteUpdateProfit">删除</view>
    </view>
  </view>
</view>